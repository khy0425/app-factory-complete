# GitHub Actions Workflow for App Factory
# Automated Flutter App Build, Test, and Deploy

name: ðŸ—¿ GigaChad App Factory CI/CD

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'generated_apps/**'
      - 'templates/**'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      app_name:
        description: 'App to deploy'
        required: true
        type: string
      deploy_target:
        description: 'Deploy target'
        required: true
        default: 'internal'
        type: choice
        options:
        - internal
        - alpha
        - beta
        - production

env:
  FLUTTER_VERSION: '3.16.0'
  JAVA_VERSION: '17'

jobs:
  # ðŸ” ì•± ê°ì§€ ë° ë³€ê²½ì‚¬í•­ ë¶„ì„
  detect_changes:
    name: ðŸ” Detect App Changes
    runs-on: ubuntu-latest
    outputs:
      changed_apps: ${{ steps.changes.outputs.apps }}
      should_deploy: ${{ steps.changes.outputs.deploy }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed apps
        id: changes
        run: |
          CHANGED_APPS=$(git diff --name-only HEAD~1 HEAD | grep "generated_apps/" | cut -d'/' -f2 | sort | uniq | jq -R . | jq -s .)
          echo "apps=${CHANGED_APPS}" >> $GITHUB_OUTPUT
          echo "deploy=${{ github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main' }}" >> $GITHUB_OUTPUT

  # ðŸ§ª ì•± í’ˆì§ˆ ê²€ì¦
  quality_check:
    name: ðŸ§ª Quality Check
    runs-on: ubuntu-latest
    needs: detect_changes
    if: needs.detect_changes.outputs.changed_apps != '[]'
    strategy:
      matrix:
        app: ${{ fromJson(needs.detect_changes.outputs.changed_apps) }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Check if app exists
        run: |
          if [ ! -d "generated_apps/${{ matrix.app }}" ]; then
            echo "âŒ App directory not found: ${{ matrix.app }}"
            exit 1
          fi

      - name: Get dependencies
        working-directory: generated_apps/${{ matrix.app }}
        run: flutter pub get

      - name: Code analysis
        working-directory: generated_apps/${{ matrix.app }}
        run: |
          flutter analyze --no-fatal-infos
          echo "âœ… Code analysis passed for ${{ matrix.app }}"

      - name: Run unit tests
        working-directory: generated_apps/${{ matrix.app }}
        run: |
          flutter test --coverage
          echo "âœ… Tests passed for ${{ matrix.app }}"

      - name: Check app signature
        working-directory: generated_apps/${{ matrix.app }}
        run: |
          # Chad signature validation
          if [ ! -f "lib/main.dart" ]; then
            echo "âŒ Main dart file missing"
            exit 1
          fi

          if ! grep -q "GigaChad\|Chad\|Alpha\|Sigma" lib/main.dart; then
            echo "âš ï¸ Warning: App might not have GigaChad branding"
          fi

          echo "âœ… App signature validated"

  # ðŸ—ï¸ ë¹Œë“œ (Android/iOS)
  build:
    name: ðŸ—ï¸ Build Apps
    runs-on: ${{ matrix.os }}
    needs: [detect_changes, quality_check]
    if: needs.detect_changes.outputs.changed_apps != '[]'

    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        app: ${{ fromJson(needs.detect_changes.outputs.changed_apps) }}
        include:
          - os: ubuntu-latest
            platform: android
            build_cmd: 'flutter build appbundle --release'
            artifact_path: 'build/app/outputs/bundle/release/app-release.aab'
          - os: macos-latest
            platform: ios
            build_cmd: 'flutter build ios --release --no-codesign'
            artifact_path: 'build/ios/iphoneos/Runner.app'

    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Setup Java (Android)
        if: matrix.platform == 'android'
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Xcode (iOS)
        if: matrix.platform == 'ios'
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 'latest-stable'

      - name: Get dependencies
        working-directory: generated_apps/${{ matrix.app }}
        run: flutter pub get

      - name: Build app
        working-directory: generated_apps/${{ matrix.app }}
        run: ${{ matrix.build_cmd }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.app }}-${{ matrix.platform }}-build
          path: generated_apps/${{ matrix.app }}/${{ matrix.artifact_path }}
          retention-days: 30

  # ðŸš€ ë°°í¬ (ìžë™)
  deploy:
    name: ðŸš€ Deploy to Stores
    runs-on: ubuntu-latest
    needs: [detect_changes, build]
    if: needs.detect_changes.outputs.should_deploy == 'true'

    strategy:
      matrix:
        app: ${{ fromJson(needs.detect_changes.outputs.changed_apps) }}

    steps:
      - uses: actions/checkout@v4

      - name: Download Android build
        uses: actions/download-artifact@v3
        with:
          name: ${{ matrix.app }}-android-build
          path: ./builds/android/

      - name: Setup Ruby (for Fastlane)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: true

      - name: Setup Fastlane
        run: |
          gem install fastlane
          echo "âœ… Fastlane installed"

      - name: Deploy to Google Play (Internal)
        env:
          GOOGLE_PLAY_SERVICE_ACCOUNT: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT }}
        run: |
          echo "ðŸš€ Deploying ${{ matrix.app }} to Google Play Internal Track"

          # Fastlane ì„¤ì • íŒŒì¼ ìƒì„±
          mkdir -p fastlane
          cat > fastlane/Fastfile << EOF
          default_platform(:android)

          platform :android do
            desc "Deploy to Google Play Internal Track"
            lane :internal do
              upload_to_play_store(
                package_name: "com.chadtech.${{ matrix.app }}",
                aab: "../builds/android/app-release.aab",
                track: "internal",
                skip_upload_apk: true,
                skip_upload_metadata: true,
                skip_upload_images: true,
                skip_upload_screenshots: true
              )
            end
          end
          EOF

          # ë°°í¬ ì‹¤í–‰
          fastlane android internal
          echo "âœ… Deployed ${{ matrix.app }} to Google Play"

  # ðŸ“Š ì„±ê³¼ ì¸¡ì • ì‹œìž‘
  start_tracking:
    name: ðŸ“Š Start Performance Tracking
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always() && needs.deploy.result == 'success'

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests python-dotenv
          echo "âœ… Python dependencies installed"

      - name: Initialize tracking
        env:
          ANALYTICS_API_KEY: ${{ secrets.ANALYTICS_API_KEY }}
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          echo "ðŸ“Š Starting performance tracking for deployed apps"

          # Analytics ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸
          python - << EOF
          import requests
          import json
          from datetime import datetime

          # ë°°í¬ ì•Œë¦¼
          webhook_url = "${{ env.SLACK_WEBHOOK }}"
          if webhook_url:
              message = {
                  "text": "ðŸ—¿ GigaChad App Factory Deployment Complete!",
                  "blocks": [
                      {
                          "type": "section",
                          "text": {
                              "type": "mrkdwn",
                              "text": f"*Deployment Summary*\nâ€¢ Timestamp: {datetime.now().isoformat()}\nâ€¢ Apps: ${{ join(fromJson(needs.detect_changes.outputs.changed_apps), ', ') }}\nâ€¢ Status: âœ… Success"
                          }
                      }
                  ]
              }
              requests.post(webhook_url, json=message)
              print("âœ… Slack notification sent")

          print("ðŸ“Š Performance tracking initialized")
          EOF

  # ðŸ§¹ ì •ë¦¬ ìž‘ì—…
  cleanup:
    name: ðŸ§¹ Cleanup
    runs-on: ubuntu-latest
    needs: [start_tracking]
    if: always()

    steps:
      - name: Clean up temporary files
        run: |
          echo "ðŸ§¹ Cleaning up deployment artifacts"
          # ìž„ì‹œ íŒŒì¼ ì •ë¦¬ ë¡œì§
          echo "âœ… Cleanup complete"

      - name: Update deployment status
        run: |
          echo "ðŸ“‹ Updating deployment status in dashboard"
          # ëŒ€ì‹œë³´ë“œ ìƒíƒœ ì—…ë°ì´íŠ¸
          echo "âœ… Status updated"